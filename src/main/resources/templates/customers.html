<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <title>Quản lý Khách Hàng</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
</head>
<body>
<div class="container mt-5">

  <!-- Nút thêm khách hàng -->
  <div class="mb-3">
    <a th:href="@{/customers/add}" class="btn btn-success">Thêm khách hàng</a>
  </div>

  <table class="table table-bordered" id="customerTable">
    <thead>
    <tr>
      <th>ID</th>
      <th>Tên</th>
      <th>Số điện thoại</th>
      <th>Địa chỉ</th>
      <th>Số dư nợ</th>
      <th>Ngày tạo</th>
      <th>Ngày cập nhật</th>
      <th>Hành động</th>
    </tr>
    <tr>
      <th>
        <input type="number" id="search-id-min" class="form-control" placeholder="Từ" />
        <input type="number" id="search-id-max" class="form-control mt-1" placeholder="Đến" />
      </th>
      <th><input type="text" id="search-name" class="form-control" placeholder="Tìm theo Tên" /></th>
      <th><input type="text" id="search-phone" class="form-control" placeholder="Tìm theo SĐT" /></th>
      <th><input type="text" id="search-address" class="form-control" placeholder="Tìm theo Địa chỉ" /></th>
      <th>
        <input type="number" id="search-debt-min" class="form-control" placeholder="Từ" />
        <input type="number" id="search-debt-max" class="form-control mt-1" placeholder="Đến" />
      </th>
      <th>
        <input type="date" id="search-created-date-min" class="form-control" placeholder="Từ" />
        <input type="date" id="search-created-date-max" class="form-control mt-1" placeholder="Đến" />
      </th>
      <th>
        <input type="date" id="search-updated-date-min" class="form-control" placeholder="Từ" />
        <input type="date" id="search-updated-date-max" class="form-control mt-1" placeholder="Đến" />
      </th>

      <th><button id="clearFilter" class="btn btn-warning">Bỏ lọc</button></th>
    </tr>
    </thead>
    <tbody>
    <tr th:each="customer,x : ${customers}">
      <td th:text="${customers.size()-x.index}"></td>
      <td th:text="${customer.name}"></td>
      <td th:text="${customer.phone}"></td>
      <td th:text="${customer.address}"></td>
      <td th:text="${customer.debtBalance}"></td>
      <td th:text="${#temporals.format(customer.createdAt, 'dd-MM-yyyy')}"></td>
      <td th:text="${#temporals.format(customer.updatedAt, 'dd-MM-yyyy')}"></td>
      <td>
        <a th:href="@{/customers/edit/{id}(id=${customer.id})}" class="btn btn-warning">Sửa</a>
        <a th:href="@{/debt/add(customerId=${customer.id})}" class="btn btn-primary btn-sm">Thêm công nợ</a>
        <a th:href="@{/debt/detail(customerId=${customer.id})}" class="btn btn-info btn-sm">Chi tiết</a>
      </td>
    </tr>
    </tbody>
  </table>
</div>

<!-- Phân trang -->
<div id="pagination" class="mt-3 text-center"></div>

<!-- JavaScript -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    let inputs = document.querySelectorAll("input");
    let rows = Array.from(document.querySelectorAll("#customerTable tbody tr"));
    let pageSize = 5; // Số khách hàng hiển thị trên mỗi trang
    let currentPage = 0;

    function applyFiltersAndPaginate() {
      let searchIdMin = parseInt(document.getElementById("search-id-min").value.trim()) || null;
      let searchIdMax = parseInt(document.getElementById("search-id-max").value.trim()) || null;
      let searchName = document.getElementById("search-name").value.trim().toLowerCase();
      let searchPhone = document.getElementById("search-phone").value.trim().toLowerCase();
      let searchAddress = document.getElementById("search-address").value.trim().toLowerCase();
      let searchDebtMin = parseFloat(document.getElementById("search-debt-min").value.trim()) || null;
      let searchDebtMax = parseFloat(document.getElementById("search-debt-max").value.trim()) || null;
      let searchCreatedDateMin = document.getElementById("search-created-date-min").value.trim();
      let searchCreatedDateMax = document.getElementById("search-created-date-max").value.trim();
      let searchUpdatedDateMin = document.getElementById("search-updated-date-min").value.trim();
      let searchUpdatedDateMax = document.getElementById("search-updated-date-max").value.trim();

      let filteredRows = rows.filter(row => {
        let cells = row.getElementsByTagName("td");

        let id = parseInt(cells[0].innerText) || 0;
        let name = cells[1].innerText.trim().toLowerCase();
        let phone = cells[2].innerText.trim().toLowerCase();
        let address = cells[3].innerText.trim().toLowerCase();
        let debt = parseFloat(cells[4].innerText) || 0;
        let createdDate = formatDate(cells[5].innerText.trim());
        let updatedDate = formatDate(cells[6].innerText.trim());

        let matches = true;

        // Kiểm tra ID
        if (searchIdMin !== null && id < searchIdMin) matches = false;
        if (searchIdMax !== null && id > searchIdMax) matches = false;

        // Kiểm tra Công nợ
        if (searchDebtMin !== null && debt < searchDebtMin) matches = false;
        if (searchDebtMax !== null && debt > searchDebtMax) matches = false;

        // Kiểm tra Tên, SĐT, Địa chỉ
        if (searchName && !name.includes(searchName)) matches = false;
        if (searchPhone && !phone.includes(searchPhone)) matches = false;
        if (searchAddress && !address.includes(searchAddress)) matches = false;
        // Kiểm tra Ngày tạo
        // Chuyển đổi ngày trong bảng (đã được chuyển đổi thành yyyy-MM-dd bởi formatDate) thành đối tượng Date
        let createdDateObj = new Date(createdDate);
        // Chuyển đổi giá trị từ input (đã có định dạng yyyy-MM-dd) thành đối tượng Date
        let searchCreatedDateMinObj = searchCreatedDateMin ? new Date(searchCreatedDateMin) : null;
        let searchCreatedDateMaxObj = searchCreatedDateMax ? new Date(searchCreatedDateMax) : null;

        if (searchCreatedDateMinObj && createdDateObj < searchCreatedDateMinObj) matches = false;
        if (searchCreatedDateMaxObj && createdDateObj > searchCreatedDateMaxObj) matches = false;



        // // Kiểm tra Ngày tạo (theo khoảng)
        // if (searchCreatedDateMin && createdDate < formatDate(searchCreatedDateMin)) matches = false;
        // if (searchCreatedDateMax && createdDate > formatDate(searchCreatedDateMax)) matches = false;

        // // Kiểm tra Ngày cập nhật (theo khoảng)
        // if (searchUpdatedDateMin && updatedDate < formatDate(searchUpdatedDateMin)) matches = false;
        // if (searchUpdatedDateMax && updatedDate > formatDate(searchUpdatedDateMax)) matches = false;

        //Kiểm tra Ngày cập nhật
        // Chuyển đổi ngày trong bảng (đã được chuyển đổi thành yyyy-MM-dd bởi formatDate) thành đối tượng Date
        let updatedDateObj = new Date(updatedDate);
       // Chuyển đổi giá trị từ input (đã có định dạng yyyy-MM-dd) thành đối tượng Date
        let searchUpdatedDateMinObj = searchUpdatedDateMin ? new Date(searchUpdatedDateMin) : null;
        let searchUpdatedDateMaxObj = searchUpdatedDateMax ? new Date(searchUpdatedDateMax) : null;

        if (searchUpdatedDateMinObj && updatedDateObj < searchUpdatedDateMinObj) matches = false;
        if (searchUpdatedDateMaxObj && updatedDateObj > searchUpdatedDateMaxObj) matches = false;

        return matches;
      });

      paginate(filteredRows);
    }

    function paginate(filteredRows) {
      let totalPages = Math.ceil(filteredRows.length / pageSize);
      let start = currentPage * pageSize;
      let end = start + pageSize;

      // Ẩn tất cả hàng
      rows.forEach(row => row.style.display = "none");

      // Hiển thị hàng phù hợp với bộ lọc
      filteredRows.slice(start, end).forEach(row => row.style.display = "");

      // Cập nhật phân trang
      updatePagination(totalPages);
    }

    function updatePagination(totalPages) {
      let paginationDiv = document.getElementById("pagination");
      paginationDiv.innerHTML = "";

      let prevButton = document.createElement("button");
      prevButton.classList.add("btn", "btn-primary", "me-2");
      prevButton.innerText = "Trang trước";
      prevButton.disabled = currentPage === 0;
      prevButton.addEventListener("click", function () {
        if (currentPage > 0) {
          currentPage--;
          applyFiltersAndPaginate();
        }
      });
      paginationDiv.appendChild(prevButton);

      let pageInfo = document.createElement("span");
      pageInfo.innerHTML = `<strong>Trang ${currentPage + 1} / ${totalPages || 1}</strong>`;
      paginationDiv.appendChild(pageInfo);

      let nextButton = document.createElement("button");
      nextButton.classList.add("btn", "btn-primary", "ms-2");
      nextButton.innerText = "Trang sau";
      nextButton.disabled = currentPage >= totalPages - 1;
      nextButton.addEventListener("click", function () {
        if (currentPage < totalPages - 1) {
          currentPage++;
          applyFiltersAndPaginate();
        }
      });
      paginationDiv.appendChild(nextButton);
    }

    // Chuyển đổi ngày từ dd-MM-yyyy sang yyyy-MM-dd để so sánh chính xác
    function formatDate(dateStr) {
      let parts = dateStr.split("-");
      return parts.length === 3 ? `${parts[2]}-${parts[1]}-${parts[0]}` : dateStr;
    }

    // Gán sự kiện cho tất cả input
    inputs.forEach(input => {
      input.addEventListener("input", function () {
        currentPage = 0;
        applyFiltersAndPaginate();
      });
    });

    // Xóa bộ lọc
    document.getElementById("clearFilter").addEventListener("click", function () {
      inputs.forEach(input => input.value = "");
      currentPage = 0;
      applyFiltersAndPaginate();
    });

    // Khởi chạy bộ lọc khi tải trang
    applyFiltersAndPaginate();
  });

</script>
</body>
</html>
