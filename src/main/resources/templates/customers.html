<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <title>Quản lý Khách Hàng</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
</head>
<body>
<div class="container mt-5">
  <h2>Danh sách Khách Hàng</h2>

  <!-- Nút thêm khách hàng -->
  <div class="mb-3">
    <a th:href="@{/customers/add}" class="btn btn-success">Thêm khách hàng</a>
  </div>

  <table class="table table-bordered" id="customerTable">
    <thead>
    <tr>
      <th>ID</th>

      <th>Tên</th>
      <th>Số điện thoại</th>
      <th>Địa chỉ</th>
      <th>Số dư nợ</th>

      <th>Ngày tạo</th>
      <th>Ngày cập nhật</th>
      <th>Hành động</th>
    </tr>
    <tr>
      <th>
        <input type="number" id="search-id-min" class="form-control" placeholder="Từ" />
        <input type="number" id="search-id-max" class="form-control mt-1" placeholder="Đến" />
      </th>
      <th><input type="text" id="search-name" class="form-control" placeholder="Tìm theo Tên" /></th>
      <th><input type="text" id="search-phone" class="form-control" placeholder="Tìm theo SĐT" /></th>
      <th><input type="text" id="search-address" class="form-control" placeholder="Tìm theo Địa chỉ" /></th>
      <th>
        <input type="number" id="search-debt-min" class="form-control" placeholder="Từ" />
        <input type="number" id="search-debt-max" class="form-control mt-1" placeholder="Đến" />
      </th>
      <th><input type="text" id="search-created-date" class="form-control" /></th>
      <th><input type="text" id="search-updated-date" class="form-control" /></th>
      <th><button id="clearFilter" class="btn btn-warning">Bỏ lọc</button></th>
    </tr>
    </thead>
    <tbody>
    <tr th:each="customer,x : ${customers}">
      <td th:text="${customers.size()-x.index}"></td>

      <td th:text="${customer.name}"></td>
      <td th:text="${customer.phone}"></td>
      <td th:text="${customer.address}"></td>
      <td th:text="${customer.debtBalance}"></td>
      <td th:text="${#temporals.format(customer.createdAt, 'dd-MM-yyyy')}"></td>
      <td th:text="${#temporals.format(customer.updatedAt, 'dd-MM-yyyy')}"></td>
      <td>
        <a th:href="@{/customers/edit/{id}(id=${customer.id})}" class="btn btn-warning">Sửa</a>

        <a th:href="@{/debt/add(customerId=${customer.id})}" class="btn btn-primary btn-sm">Thêm công nợ</a>
        <a th:href="@{/debt/detail(customerId=${customer.id})}" class="btn btn-info btn-sm">Chi tiết</a>

      </td>
    </tr>
    </tbody>
  </table>
  <div>
    <a class="btn btn-primary" th:href="@{home}">Trang chủ</a>
  </div>
</div>

<!-- Phân trang -->
<div id="pagination" class="mt-3 text-center"></div>

<!-- JavaScript -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    let inputs = document.querySelectorAll("input");
    let rows = document.querySelectorAll("#customerTable tbody tr");
    let pageSize = 5;  // Số khách hàng hiển thị trên mỗi trang
    let currentPage = 0;

    function applyFiltersAndPaginate() {
      let searchIdMin = parseInt(document.getElementById("search-id-min").value) || null;
      let searchIdMax = parseInt(document.getElementById("search-id-max").value) || null;
      let searchName = document.getElementById("search-name").value.toLowerCase();
      let searchPhone = document.getElementById("search-phone").value.toLowerCase();
      let searchAddress = document.getElementById("search-address").value.toLowerCase();
      let searchDebtMin = parseFloat(document.getElementById("search-debt-min").value) || null;
      let searchDebtMax = parseFloat(document.getElementById("search-debt-max").value) || null;

      let filteredRows = [];
      rows.forEach(row => {
        let id = parseInt(row.cells[0].innerText) || 0;
        let name = row.cells[2].innerText.toLowerCase();
        let phone = row.cells[3].innerText.toLowerCase();
        let address = row.cells[4].innerText.toLowerCase();
        let debt = parseFloat(row.cells[5].innerText) || 0;

        let matches = true;

        // Kiểm tra khoảng giá trị cho ID
        if ((searchIdMin !== null && id < searchIdMin) || (searchIdMax !== null && id > searchIdMax)) {
          matches = false;
        }

        // Kiểm tra khoảng giá trị cho Công nợ
        if ((searchDebtMin !== null && debt < searchDebtMin) || (searchDebtMax !== null && debt > searchDebtMax)) {
          matches = false;
        }

        // Kiểm tra các bộ lọc khác
        if (searchName && !name.includes(searchName)) matches = false;
        if (searchPhone && !phone.includes(searchPhone)) matches = false;
        if (searchAddress && !address.includes(searchAddress)) matches = false;

        if (matches) {
          filteredRows.push(row);
        }
      });

      paginate(filteredRows);
    }

    function paginate(filteredRows) {
      let totalPages = Math.ceil(filteredRows.length / pageSize);
      let start = currentPage * pageSize;
      let end = start + pageSize;

      // Ẩn tất cả hàng
      rows.forEach(row => row.style.display = "none");

      // Hiển thị hàng phù hợp với bộ lọc
      filteredRows.slice(start, end).forEach(row => row.style.display = "");

      // Cập nhật phân trang
      updatePagination(totalPages);
    }

    function updatePagination(totalPages) {
      let paginationDiv = document.getElementById("pagination");
      paginationDiv.innerHTML = ""; // Xóa nội dung cũ

      let prevButton = document.createElement("button");
      prevButton.classList.add("btn", "btn-primary", "me-2");
      prevButton.innerText = "Trang trước";
      prevButton.disabled = currentPage === 0;
      prevButton.addEventListener("click", function () {
        if (currentPage > 0) {
          currentPage--;
          applyFiltersAndPaginate();
        }
      });
      paginationDiv.appendChild(prevButton);

      let pageInfo = document.createElement("span");
      pageInfo.innerHTML = `<strong>Trang ${currentPage + 1} / ${totalPages || 1}</strong>`;
      paginationDiv.appendChild(pageInfo);

      let nextButton = document.createElement("button");
      nextButton.classList.add("btn", "btn-primary", "ms-2");
      nextButton.innerText = "Trang sau";
      nextButton.disabled = currentPage >= totalPages - 1;
      nextButton.addEventListener("click", function () {
        if (currentPage < totalPages - 1) {
          currentPage++;
          applyFiltersAndPaginate();
        }
      });
      paginationDiv.appendChild(nextButton);
    }

    // Gán sự kiện cho tất cả input
    inputs.forEach(input => {
      input.addEventListener("input", function () {
        currentPage = 0;
        applyFiltersAndPaginate();
      });
    });

    // Xóa bộ lọc
    document.getElementById("clearFilter").addEventListener("click", function () {
      inputs.forEach(input => input.value = "");
      currentPage = 0;
      applyFiltersAndPaginate();
    });

    // Khởi chạy bộ lọc khi tải trang
    applyFiltersAndPaginate();
  });
</script>
</body>
</html>
